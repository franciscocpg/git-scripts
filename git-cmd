#!/bin/bash
CMD="$1"
CMD_ARGS="$2"
GIT_REPO_PATH="$3"
clear

printCmd() {
  echo -e "\n=========================================="
  echo "$CMD $CMD_ARGS $path"
}

gitCmdExec() {
  local print="$1"
  if [[ "$print" = "true" ]]; then
    printCmd
  fi
  if [ "$CMD_ARGS" != "" ]
  then
    args=( "$CMD_ARGS" )
    if [[ "$CMD_ARGS" = *"-m"* ]]
    then
      git $CMD "${args[@]}"
    else 
      git $CMD ${args[@]}
    fi
  else
    git $CMD
  fi
}

gitCmd() {
  local path="$1"
  cd "$path"
  execGitCmd="true"
  if [[ "$CMD" = "push" ]]; then
    outputCmd=$(git status -s -b)
    # Pega a primeira linha da saida
    outputCmd=$(echo -e "$outputCmd" | sed -n 1p)
    # Não executa o push se a saida não contém o caracter [
    if [[ "$outputCmd" != *"["* ]]
    then
      execGitCmd="false"
    fi
  fi
  if [[ "$execGitCmd" = "true" ]]; then
    if [[ "$CMD" = "status" ]]; then
     outputCmd=$(gitCmdExec)
      if [[ "$outputCmd" != "## master...origin/master" ]]; then
        printCmd
        echo "$outputCmd"
      fi
    else
      gitCmdExec "true"
    fi
  fi
  cd .. 
}


out=""
if [[ "$GIT_REPO_PATH" = "" ]]; then
  for dir in */; do
    if [[ "$CMD" = "status" || "$CMD" = "push" ]]; then
      out=${out}$(gitCmd "$dir")
    else
      gitCmd "$dir"
      out=" "
    fi 
  done
else
  if [[ "$CMD" = "status" || "$CMD" = "push" ]]; then
    out=$(gitCmd "$GIT_REPO_PATH")
  else
    gitCmd "$GIT_REPO_PATH"
    out=" "
  fi
fi

if [[ -z "$out" ]]; then
  echo "Nada a fazer"
else
  echo "$out"
fi  